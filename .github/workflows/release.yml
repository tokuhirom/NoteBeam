name: Release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write

jobs:
  build:
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@34e114876b0b11c390a56381ad16ebd13914f8d5 # v4.3.1

      - uses: actions/setup-go@40f1582b2485089dde7abd97c1529aa768e1baff # v5.6.0
        with:
          go-version-file: go.mod

      - uses: actions/setup-node@49933ea5288caeca8642d1e84afbd3f7d6820020 # v4.4.0
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: frontend/package-lock.json

      - name: Install Wails
        run: go install github.com/wailsapp/wails/v2/cmd/wails@latest

      - name: Install frontend dependencies
        run: npm ci
        working-directory: frontend

      - name: Build for macOS (arm64)
        run: wails build -platform darwin/arm64

      - name: Create zip
        run: |
          cd build/bin
          zip -r NoteBeam_${{ github.ref_name }}_darwin_arm64.zip NoteBeam.app

      - name: Build for macOS (amd64)
        run: |
          rm -rf build/bin
          wails build -platform darwin/amd64

      - name: Create zip (amd64)
        run: |
          cd build/bin
          zip -r NoteBeam_${{ github.ref_name }}_darwin_amd64.zip NoteBeam.app

      - name: Calculate checksums
        id: checksums
        run: |
          ARM64_SHA256=$(shasum -a 256 build/bin/NoteBeam_${{ github.ref_name }}_darwin_arm64.zip | awk '{print $1}')
          AMD64_SHA256=$(shasum -a 256 build/bin/NoteBeam_${{ github.ref_name }}_darwin_amd64.zip | awk '{print $1}')

          # Validate checksums are not empty
          if [ -z "$ARM64_SHA256" ]; then
            echo "ERROR: Failed to calculate ARM64 checksum"
            exit 1
          fi
          if [ -z "$AMD64_SHA256" ]; then
            echo "ERROR: Failed to calculate AMD64 checksum"
            exit 1
          fi

          echo "ARM64 SHA256: $ARM64_SHA256"
          echo "AMD64 SHA256: $AMD64_SHA256"

          echo "arm64_sha256=$ARM64_SHA256" >> $GITHUB_OUTPUT
          echo "amd64_sha256=$AMD64_SHA256" >> $GITHUB_OUTPUT
          VERSION="${{ github.ref_name }}"
          echo "version=${VERSION#v}" >> $GITHUB_OUTPUT

      - name: Upload to Release
        uses: softprops/action-gh-release@a06a81a03ee405af7f2048a818ed3f03bbf83c7b # v2.5.0
        with:
          files: |
            build/bin/NoteBeam_${{ github.ref_name }}_darwin_arm64.zip
            build/bin/NoteBeam_${{ github.ref_name }}_darwin_amd64.zip

      - name: Update Homebrew Cask
        env:
          TAP_GITHUB_TOKEN: ${{ secrets.TAP_GITHUB_TOKEN }}
          VERSION: ${{ steps.checksums.outputs.version }}
          ARM64_SHA256: ${{ steps.checksums.outputs.arm64_sha256 }}
          AMD64_SHA256: ${{ steps.checksums.outputs.amd64_sha256 }}
        run: |
          # Validate environment variables
          if [ -z "$TAP_GITHUB_TOKEN" ]; then
            echo "ERROR: TAP_GITHUB_TOKEN is not set"
            exit 1
          fi
          if [ -z "$VERSION" ]; then
            echo "ERROR: VERSION is not set"
            exit 1
          fi
          if [ -z "$ARM64_SHA256" ]; then
            echo "ERROR: ARM64_SHA256 is not set"
            exit 1
          fi
          if [ -z "$AMD64_SHA256" ]; then
            echo "ERROR: AMD64_SHA256 is not set"
            exit 1
          fi

          git clone https://x-access-token:${TAP_GITHUB_TOKEN}@github.com/tokuhirom/homebrew-tap.git
          cd homebrew-tap

          mkdir -p Casks
          cat > Casks/notebeam.rb <<EOF
cask "notebeam" do
  arch arm: "arm64", intel: "amd64"

  version "${VERSION}"
  sha256 arm: "${ARM64_SHA256}", intel: "${AMD64_SHA256}"

  url "https://github.com/tokuhirom/NoteBeam/releases/download/v#{version}/NoteBeam_v#{version}_darwin_#{arch}.zip"
  name "NoteBeam"
  desc "Simple memo app for Mac"
  homepage "https://github.com/tokuhirom/NoteBeam"

  app "NoteBeam.app"

  zap trash: "~/Documents/NoteBeam"
end
EOF

          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add Casks/notebeam.rb
          git commit -m "Update NoteBeam to ${VERSION}" || echo "No changes to commit"
          git push
